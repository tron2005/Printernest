<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<title>Spr√°vce soubor≈Ø</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body { display: flex; height: 100vh; margin: 0; font-family: Arial,sans-serif; }
  #sidebar { width: 300px; background-color: #f8f9fa; overflow-y: auto; border-right: 1px solid #ddd; }
  #sidebar .folder { padding: 8px 16px; cursor: pointer; display:flex; justify-content:space-between; align-items:center; }
  #sidebar .folder.active { background-color: #0d6efd; color: white; font-weight: bold; }
  #main { flex: 1; padding: 20px; overflow-y: auto; }
  .file-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eaeaea; align-items: center; }
  .file-row:hover { background: #f1f3f5; }
  .file-info-container { display: flex; align-items: center; gap: 12px; white-space: nowrap; flex-grow: 1; min-width: 0; }
  .file-name-link { font-weight: 500; text-decoration: none; color: inherit; }
  .file-name-link:hover { text-decoration: underline; }
  
  .file-thumb {
    max-width: 55px; max-height: 55px; object-fit: contain;
    border-radius: 4px; border: 1px solid #ccc;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    cursor: pointer;
  }
  .file-row:hover .file-thumb {
    transform: scale(4);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    position: absolute;
    z-index: 10;
  }
  .file-details {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: flex-start;
    overflow: hidden;
  }
  .file-metadata-inline {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    font-size: 0.8rem;
    color: #555;
    gap: 8px;
    margin-top: 4px;
  }
  .file-metadata-inline span {
    background-color: #e9ecef;
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
  }
  .note-badge {
      font-size: 0.8rem;
      font-weight: normal;
      margin-left: 8px;
  }
</style>
</head>
<body>

<div id="sidebar">
  <div class="d-flex align-items-center justify-content-between p-3 border-bottom">
    <h5 class="mb-0">Slo≈æky</h5>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm" style="font-size:0.9em;">‚Üê Zpƒõt</a>
  </div>
  <div id="folderTree"></div>
  <div class="p-3">
    <input type="text" id="newFolderName" class="form-control mb-2" placeholder="Nov√° slo≈æka" />
    <button class="btn btn-primary w-100" onclick="createFolder()">Vytvo≈ôit slo≈æku</button>
  </div>
</div>

<div id="main" class="p-3">
  <div class="mb-3">
    <label><strong>Vyu≈æit√≠ disku:</strong> <span id="diskUsagePercent">0%</span></label>
    <div class="progress">
      <div id="diskUsageBar" class="progress-bar bg-success" style="width: 0%;"></div>
    </div>
  </div>

  <div class="mb-3 d-flex align-items-center gap-2">
    <input type="file" id="fileInput" class="form-control" />
    <button class="btn btn-success" onclick="uploadFile()">Nahr√°t</button>
  </div>

  <input type="text" id="searchQuery" class="form-control mb-3" placeholder="Hledat soubor" oninput="filterFiles()" />

  <div id="fileList"></div>
</div>

<script>
  let currentFolder = 'hlavni_slozka';
  let draggedFile = null;

  async function fetchFolderTree() {
    const res = await fetch('/all_folders/');
    const data = await res.json();
    const tree = document.getElementById('folderTree');
    tree.innerHTML = '';
    data.folders.forEach(folder => {
      if(folder === 'thumbnails') return;
      const div = document.createElement('div');
      div.className = 'folder' + (folder === currentFolder ? ' active' : '');
      div.innerHTML = `<span>${folder || '/'}</span><span></span>`;
      if(folder && folder !== 'hlavni_slozka') {
        let btns = document.createElement('span');
        let renameBtn = document.createElement('button');
        renameBtn.className = "btn btn-sm btn-outline-secondary";
        renameBtn.textContent = '‚úè';
        renameBtn.onclick = e => { e.stopPropagation(); renameFolderPrompt(folder); };
        btns.appendChild(renameBtn);
        let delBtn = document.createElement('button');
        delBtn.className = "btn btn-sm btn-outline-danger ms-1";
        delBtn.textContent = 'üóë';
        delBtn.onclick = e => { e.stopPropagation(); deleteFolder(folder); };
        btns.appendChild(delBtn);
        div.lastElementChild.replaceWith(btns);
      }
      div.onclick = () => fetchFiles(folder);
      div.ondragover = e => e.preventDefault();
      div.ondrop = e => onDrop(e, folder);
      tree.appendChild(div);
    });
  }

  async function fetchFiles(folder = currentFolder) {
    const url = folder ? `/files_in_folder/?foldername=${encodeURIComponent(folder)}` : '/files/';
    const res = await fetch(url);
    if(!res.ok) { alert("Nelze naƒç√≠st obsah slo≈æky."); return; }
    const data = await res.json();
    currentFolder = folder;
    await updateFileList(data.files);
    await fetchFolderTree();
  }

  async function updateFileList(files) {
    const list = document.getElementById('fileList');
    list.innerHTML = '';
    for(const file of files) {
        const fullPath = currentFolder ? `${currentFolder}/${file}` : file;
        
        const row = document.createElement('div');
        row.className = 'file-row';
        row.draggable = true;
        row.ondragstart = e => { draggedFile = fullPath; };
        
        row.innerHTML = `
            <div class="file-info-container">
                <div class="image-placeholder" style="width:55px; height:55px; flex-shrink: 0; border: 1px solid #eee; border-radius: 4px;"></div>
                <div class="file-details">
                    <div class="file-name-container"><a href="/file_detail/${encodeURIComponent(fullPath)}" class="file-name-link">${file}</a></div>
                    <div class="file-metadata-inline">
                        <span class="text-muted">Naƒç√≠t√°n√≠...</span>
                    </div>
                </div>
            </div>
            <span>
              <a href="/download/${encodeURIComponent(fullPath)}" class="btn btn-sm btn-primary me-1">St√°hnout</a>
              <button class="btn btn-sm btn-secondary me-1" onclick="renameFilePrompt('${fullPath}')">P≈ôejmenovat</button>
              <button class="btn btn-sm btn-info me-1" onclick="notePrompt('${fullPath}')">Pozn√°mka</button>
              <button class="btn btn-sm btn-danger me-1" onclick="deleteFile('${fullPath}')">Smazat</button>
            </span>`;
        list.appendChild(row);

        fetch(`/file_metadata/?file_path=${encodeURIComponent(fullPath)}`)
            .then(res => res.ok ? res.json() : Promise.reject('Chyba s√≠tƒõ'))
            .then(metaData => {
                let imgTag = '<div style="width:55px; height:55px; border:1px solid #ccc; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:0.7rem; color:#888; flex-shrink: 0;">Bez n√°hledu</div>';
                if(metaData.thumbnail_files && metaData.thumbnail_files.length) {
                    imgTag = `<img src="${metaData.thumbnail_files[0]}" class="file-thumb" alt="miniatura">`;
                }
                
                let metaInlineHTML = '';
                if(metaData.file_type) metaInlineHTML += `<span>${metaData.file_type}</span>`;
                if(metaData.printer_model) metaInlineHTML += `<span>üñ®Ô∏è ${metaData.printer_model}</span>`;
                if(metaData.nozzle_diameter) metaInlineHTML += `<span>‚óé ${metaData.nozzle_diameter} mm</span>`;
                if(metaData.print_time) metaInlineHTML += `<span>üïí ${metaData.print_time}</span>`;
                if(metaData.modified) metaInlineHTML += `<span>üìÖ ${metaData.modified}</span>`;
                
                let noteBadgeHTML = '';
                if(metaData.note) {
                    noteBadgeHTML = `<span class="badge bg-info note-badge">${metaData.note}</span>`;
                }
                
                const imagePlaceholder = row.querySelector('.image-placeholder');
                const fileNameContainer = row.querySelector('.file-name-container');
                const metadataContainer = row.querySelector('.file-metadata-inline');

                if(imagePlaceholder) imagePlaceholder.innerHTML = imgTag;
                if(fileNameContainer) fileNameContainer.innerHTML = `<a href="/file_detail/${encodeURIComponent(fullPath)}" class="file-name-link">${file}</a> ${noteBadgeHTML}`;
                if(metadataContainer) metadataContainer.innerHTML = metaInlineHTML;
            })
            .catch(err => {
                const metadataContainer = row.querySelector('.file-metadata-inline');
                if (metadataContainer) {
                    metadataContainer.innerHTML = '<span class="text-danger">Chyba metadat</span>';
                }
            });
    }
  }

  // ... (ostatn√≠ JS funkce z≈Øst√°vaj√≠ stejn√©) ...
  async function uploadFile() {
    const input = document.getElementById('fileInput');
    if(!input.files.length) { alert('Vyberte soubor'); return; }
    const formData = new FormData();
    formData.append('file', input.files[0]);
    formData.append('path', currentFolder);
    await fetch('/upload/', { method:'POST', body: formData });
    fetchFiles(currentFolder);
  }

  async function createFolder() {
    const input = document.getElementById('newFolderName');
    const folderName = input.value.trim();
    if(!folderName) return;
    const formData = new FormData();
    let fullPath = folderName;
    if(currentFolder && currentFolder !== '') fullPath = currentFolder + '/' + folderName;
    formData.append('foldername', fullPath);
    await fetch('/folders/', { method:'POST', body: formData });
    input.value = '';
    fetchFolderTree();
    fetchFiles(currentFolder);
  }

  async function deleteFolder(folder) {
    if(!confirm(`Opravdu smazat celou slo≈æku "${folder}" ?`)) return;
    const formData = new FormData();
    formData.append('foldername', folder);
    await fetch('/delete_folder/', { method:'POST', body: formData });
    fetchFolderTree();
    fetchFiles(currentFolder);
  }

  async function renameFolderPrompt(folder) {
    let newName = prompt("Zadejte nov√Ω n√°zev slo≈æky:", folder.split('/').pop());
    if(!newName) return;
    const formData = new FormData();
    formData.append('source', folder);
    formData.append('target', newName);
    await fetch('/rename_folder/', { method: 'POST', body: formData });
    fetchFolderTree();
    fetchFiles(currentFolder);
  }

  async function renameFilePrompt(file) {
    let base = file.split('/').pop();
    let dotIndex = base.lastIndexOf('.');
    let nameOnly = dotIndex > -1 ? base.substring(0,dotIndex) : base;
    let ext = dotIndex > -1 ? base.substring(dotIndex) : "";
    let newName = prompt("Zadejte nov√Ω n√°zev souboru:", nameOnly);
    if(!newName) return;
    newName += ext;
    const formData = new FormData();
    formData.append('old_name', file);
    formData.append('new_name', newName);
    await fetch('/rename_file/', { method:'POST', body: formData });
    fetchFiles(currentFolder);
  }

  async function notePrompt(file) {
    const res = await fetch(`/get_note/?file_path=${encodeURIComponent(file)}`);
    const data = await res.json();
    let newNote = prompt("Pozn√°mka k souboru:", data.note || '');
    if(newNote === null) return;
    const formData = new FormData();
    formData.append('file_path', file);
    formData.append('note', newNote);
    await fetch('/save_note/', { method:'POST', body: formData });
    fetchFiles(currentFolder);
  }

  async function deleteFile(file) {
    if(!confirm('Opravdu smazat tento soubor?')) return;
    const formData = new FormData();
    formData.append('filename', file);
    const res = await fetch('/delete_file/', { method:'POST', body: formData });
    if(!res.ok) { alert('Chyba p≈ôi maz√°n√≠ souboru'); return; }
    const data = await res.json();
    if(data.error) { alert("Chyba: " + data.error); } else { fetchFiles(currentFolder); }
  }

  function filterFiles() {
    let query = document.getElementById('searchQuery').value.toLowerCase();
    document.querySelectorAll('#fileList .file-row').forEach(row => {
      let text = row.textContent.toLowerCase();
      row.style.display = text.includes(query) ? '' : 'none';
    });
  }
  
  async function updateDiskUsage() {
    try {
      const res = await fetch('/disk_usage/');
      if(res.ok) {
        const data = await res.json();
        let percent = data.disk_usage_percent;
        const bar = document.getElementById('diskUsageBar');
        const label = document.getElementById('diskUsagePercent');
        bar.style.width = percent + '%';
        label.textContent = percent.toFixed(1) + '%';
        bar.setAttribute('aria-valuenow', percent);
        bar.className = 'progress-bar ' + (percent > 90 ? 'bg-danger' : 'bg-success');
      }
    } catch(err) { console.error('Disk usage error:', err); }
  }
  
  function onDrop(e, folder) {
    e.preventDefault();
    if (!draggedFile || folder === currentFolder) return;
    const formData = new FormData();
    formData.append('filename', draggedFile);
    formData.append('target_folder', folder);
    fetch('/move/', { method: 'POST', body: formData }).then(() => {
        draggedFile = null;
        fetchFiles(currentFolder);
    });
  }

  window.onload = () => {
    fetchFolderTree();
    fetchFiles(currentFolder);
    updateDiskUsage();
    setInterval(updateDiskUsage, 30000);
  };
</script>

</body>
</html>
